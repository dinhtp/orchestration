#!/usr/bin/env bash

# Prepare Magento installation command
# https://experienceleague.adobe.com/en/docs/commerce-operations/installation-guide/advanced
cmd="php -f ./bin/magento setup:install
	--base-url=$MAGENTO_URL
    --db-host=$DB_HOST
    --db-name=$DB_NAME
    --db-user=$DB_USER
    --db-password=$DB_PASSWORD
    --backend-frontname=$ADMIN_URL
    --admin-firstname=$ADMIN_FIRST_NAME
    --admin-lastname=$ADMIN_LAST_NAME
    --admin-email=$ADMIN_EMAIL
    --admin-user=$ADMIN_USERNAME
    --admin-password=$ADMIN_PASSWORD
    --language=$MAGENTO_LANGUAGE
    --currency=$MAGENTO_CURRENCY
    --timezone=$MAGENTO_TIMEZONE
    --use-rewrites=$MAGENTO_USE_REWRITES
    --use-secure-admin=$ADMIN_USE_SECURE
    --admin-use-security-key=$ADMIN_SECURITY_KEY "

if [ "$MAGENTO_SAMPLE_DATA" = "1" ]; then cmd+="--use-sample-data "; fi

if [[ ! -z "$DB_PREFIX" ]]; then cmd+="--db-prefix=$DB_PREFIX "; fi

if [[ ! -z "$ES_HOST" ]]
then
	cmd+="--search-engine=Elasticsearch "
	cmd+="--elasticsearch-host=$ES_HOST "
	cmd+="--elasticsearch-port=$ES_PORT "
fi

if [[ $etsAuth -eq 1 ]]
then
	cmd+="--elasticsearch-username=$ES_USERNAME "
	cmd+="--elasticsearch-password=$ES_PASSWORD "
fi

# Execute Setup Install Script
echo "Building Installation Script"
echo "Installation Script:"
echo "$cmd"

eval "$cmd"

# Execute Dependency Command
if [[ $MAGENTO_SAMPLE_DATA = "1" ]];
then
php -f ./bin/magento sampledata:deploy
fi

php -f ./bin/magento setup:upgrade
php -f ./bin/magento setup:di:compile
php -f ./bin/magento setup:static-content:deploy -f
php -f ./bin/magento indexer:set-mode schedule
php -f ./bin/magento indexer:reindex
php -f ./bin/magento deploy:mode:set "$MAGENTO_MODE"
php -f ./bin/magento cache:flush

# Install npm, grunt and cron
mv package.json.sample package.json
mv Gruntfile.js.sample Gruntfile.js
npm i

# Finish Installation
composer dump-autoload -o
chmod -R 777 var/ pub/ generated/
echo "
===================== Installation Complete ===================

		Magento 2 Installed successfully!

		Admin URL: $MAGENTO_URL/$ADMIN_URL
		User: $ADMIN_USERNAME
		Password: $ADMIN_PASSWORD
	  Deployment Mode: $MAGENTO_MODE

		Build something amazing!

==============================================================="